---
{"dg-publish":true,"permalink":"/剑网3工作文档/悬赏改造测试文档/"}
---

需求文档： https://365.kdocs.cn/l/cqg7kYWNHTKj
新增悬赏活动开关：1017  
新增野外复仇开关：999
需求文档：[https://365.kdocs.cn/l/cqg7kYWNHTKj?from=koa&reqtype=kdocs&startTime=1746502931650](https://365.kdocs.cn/l/cqg7kYWNHTKj?from=koa&reqtype=kdocs&startTime=1746502931650 "悬赏改造.ksheet")
测试分析：[https://365.kdocs.cn/view/l/cdwNOQ43RsP9](https://365.kdocs.cn/view/l/cdwNOQ43RsP9 "悬赏改造测试分析（备用）.pof")
Bug文档：[https://365.kdocs.cn/l/ck1ZNktyZ81Q?R=L1MvMQ==](https://365.kdocs.cn/l/ck1ZNktyZ81Q?R=L1MvMQ== "剑网3_2025悬赏改造.dbt")
# 一、数据库对应的表：  
privatewantedtable是私有悬赏，ID= CompleteWanted的nWantedID和GetPrivateWantedInfo的nID  
wantedplayertable是公开悬赏  

# 一些测试指令
## 1. 改角色名指令：
GCCommand("Rename("..player.dwID..", '成个女人一样@斗转星移')") 
现行GCCommand("AddRenameRole('" .. player.szName .. "')")

## 2. 财产冻结测试指令：  
```
GCCommand("AssetFreeze(GetRoleByName('成个女人一样@斗转星移').dwPlayerID,3600)")  
3600改成0就解除冻结了，敲完下面这个指令看聊天频道有输出时false说明已经处于冻结状态  
GCCommand("SendToPlayerGmAnnounce('"..player.szName.."',tostring(CanDelRole(GetRoleByName('成个女人一样@斗转星移').dwPlayerID)), 1)")  
  
GCCommand("FreezeRole('成个女人一样@斗转星移',12345,'robot',3)") 冻结  
GCCommand("FreezeRole('成个女人一样@斗转星移',0,'robot',3)") 解冻  
```

  
## 3. 单独对某人悬赏指令： 
```
player.Wanted("北城肆",3000, true, true)  
```
  
## 4. 批量发布悬赏指令：（利用机器人）  
```
local tPlayerIDList = player.GetScene().GetAllPlayer()  
for j = 1, #tPlayerIDList do  
    local Splayer = GetPlayer(tPlayerIDList[j])  
    Splayer.AddMoney(100000,0,0) #加金钱  
    Splayer.Wanted("被悬赏人名字", 悬赏金, 是否私密true/false, 是否匿名true/false) #发布悬赏  
end
```

```
local tPlayerIDList = player.GetScene().GetAllPlayer()  
for j = 1, #tPlayerIDList do  
    local Splayer = GetPlayer(tPlayerIDList[j])  
    Splayer.AddMoney(100000,0,0) 
    Splayer.Wanted("山有木兮", 3000, true, false) 
end
```

## 5. 远程调用发起悬赏
/ RemoteCallToServer("OnWantedPlayer", szWantedManName, nMoneyG, bPrivate, bAnonymity)
/ RemoteCallToServer("OnWantedPlayer", "雪凉柚", 2000, true, true)
for i=1,10 do RemoteCallToServer("OnWantedPlayer", "雪凉柚", 2000, true, true) end

## 6. 删号操作：
player.nLevel = 1 然后返回选角界面删掉他
GCCommand("DelRole(GetRoleByName('晟友').dwPlayerID)")可以删但不一定删成功

## 7. 变大侠号指令
player.SetForceID(0);player.UmountKungfu()--变大侠号

# 三、服务器操作
参考文档：[365.kdocs.cn/passport/singlesign?cb=https%3A%2F%2F365.kdocs.cn%2Fview%2Fl%2Fccj0tcyBqubk%3Fopenfrom%3Ddocs&form=kdocs](https://365.kdocs.cn/l/ccj0tcyBqubk?openfrom=docs)
## 1. 1、转服操作
GCCommand("StartRoleSwitchCenter(GetRoleByName('明月何灼灼').dwPlayerID, '一号服务器')")， ps：一定要启家园服务器，不然会卡转服= =，输了没反应看GC和GS有没报错，以下是成功后原GClog
![转服Log.png](/img/user/%E5%9B%BE%E7%89%87/%E8%BD%AC%E6%9C%8DLog.png)

## 2. 2、合服操作
合服前先启动一遍的服务器：
![Pasted image 20250722111925.png](/img/user/%E5%9B%BE%E7%89%87/Pasted%20image%2020250722111925.png)
### 2.1. 相关报错
#### 2.1.1. 运行exe有系统报错，缺少dll文件
解决方法：从server文档里复制一份在bin64里
![合服报错_1.png](/img/user/%E5%9B%BE%E7%89%87/%E5%90%88%E6%9C%8D%E6%8A%A5%E9%94%99_1.png)

#### 2.1.2. log报错：CenterID错误
KGMLOG_PROCESS_ERROR(dwSrcCenterID == m_Settings.m_dwSrcCenterID) at line 856 in KMergeTool::CheckSettingCenterID: dwSrcCenterID, m_Settings.m_dwSrcCenterID=3, 9
![Pasted image 20250718034426.png](/img/user/%E5%9B%BE%E7%89%87/Pasted%20image%2020250718034426.png)解决方法：修改merge_settings.ini的CenterID
![Pasted image 20250718035007.png](/img/user/%E5%9B%BE%E7%89%87/Pasted%20image%2020250718035007.png)
方法一：直接看报错最后第一个数字，如上图改为3
方法二：开服务器 zone server或者ID server 会显示你服务器ID![Pasted image 20250718034604.png](/img/user/%E5%9B%BE%E7%89%87/Pasted%20image%2020250718034604.png)
方法三：再不行 直接看跨服副本的配置，GameCenterRelation.tab


#### 2.1.3. log报错：服务器开不够，角色库少了表
KGLOG_PROCESS_ERROR(IsSrcTableExists("Community")) at line 710 in KMergeTool::CheckTableExists
![Pasted image 20250718035351.png](/img/user/%E5%9B%BE%E7%89%87/Pasted%20image%2020250718035351.png)
解决方法：启动对应服务器，上面的报错就是家园服务器没开启，没有对应表
注意点：家园服务器记得数据库要和角色数据库用同一个，不能改本地时间
bftongleagueinfo bftongleaguematchinfo 战场服务器数据库清一下这2个表

#### 2.1.4. log报错：ip填写错误
![Pasted image 20250719141552.png](/img/user/%E5%9B%BE%E7%89%87/Pasted%20image%2020250719141552.png)
解决方法：可以参考sever里relay_settings.ini的配置

#### 2.1.5. log报错：两个服时间不匹配
![Pasted image 20250719143255.png](/img/user/%E5%9B%BE%E7%89%87/Pasted%20image%2020250719143255.png)
解决方法：调时间重启服务器

Auction表不存在scrDB中
把scrDB配置写到AuctionDB.ini Mysql启动KG_ServerFrameExeX64D.exe
![Pasted image 20250722142047.png](/img/user/%E5%9B%BE%E7%89%87/Pasted%20image%2020250722142047.png)


# 四、相关文件
## 1. 逻辑ini配置项
**client/settings/GameWorldConstList.ini**
[WANTED_PLAYER]
MinimumGoldLimit=3000;悬赏最小额度（金）
WantedExistTime=604800;公开悬赏有效时限7days
SinglePayMaxGoldLimit=2000000;对单人悬赏的上限（金）
PrivateWantedExistTime=259200;私密悬赏有效时限3days
PlayerWantedMaxCount=1000;单个角色被悬赏的最大次数
WantedMaxCount=1000;每个服最大悬赏总数
ProtectTime=3600;被悬赏后再次被悬赏的CD1h


## 2. 发起悬赏的函数脚本
**scripts\script_server.lua**
OnWantedPlayer(player, szWantedManName, nMoneyG, bPrivate, bAnonymity)悬赏参与条件、发奖
改动：取消非战斗状态限制，加是否私密和是都匿名标记，取消传字符串，增加活动开关
OnGetWantedMinMoneyLimitRequest(player, szWantedManName, bPrivate) 向服务器发起请求
改动：加是否私密和是都匿名标记

## 3. 悬赏金服务器与客户端请求和响应回调
**scripts/center_remote.lua**
OnGetWantedMinMoneyLimitRespond悬赏金判断

**server/center_scripts/remote.lua**
OnGetWantedMinMoneyLimitRequest (nConnIndex, dwPlayerID, szWantedManName, bPrivate) 尝试发布悬赏回调
改动：加是否私密标记，改接口参数

**ui/Script/RemoteCommand.lua**
RemoteFunction.OnGetWantedMinMoneyLimitRespond(szWantedManName, nMinLimit, nMaxLimit)页面悬赏金请求
帮会信息是开始悬赏的那一时刻记录的
如果结算和悬赏那一刻不是一个帮会那就不能获得

## 4. 判断完成悬赏的函数脚本
**scripts/player/PlayerDeath.lua**
OnDeathCommon(player, killer) 死亡函数判断
	存储最近3个击杀者KillBanEscape(scene, killer, player)
	击杀被悬赏玩家，给予目标惩罚buff6480（大小攻防延迟buff15812）
	悬赏相关惩罚处理
		若击杀者非自己，判断是否符合击杀条件IsFinishWanted(player, killer)，`bIsFinishWanted=true`执行CheckFinishWanted(player, killer, scene, tWantedID)完成悬赏击杀，CompleteWanted(player.dwID, killer.dwID, tWantedID)（完成私密的同时也会执行完成公开）
		
IsFinishWanted(player, killer)是否满足完成一次悬赏击杀的条件
	`bIsFinishWanted=true可击杀/false不可击杀`
	刚发布10s内悬赏不生效，buff31297
	身上含有公开悬赏
	身上含有私密悬赏
		私密悬赏条件1：与发布者同帮会or帮会同盟
		私密悬赏条件2：与发布者组队
		隐藏条件：就是发布者自己
CheckFinishWanted(player, killer, scene, tWantedID)完成悬赏击杀
	判断是否攻防时间IsInGFMapInGFTime(scene)=true添加攻防延迟buff15812
	非攻防时间判断是否野外图，根据杀气值不同加的6480buff等级不同


## 5. 发布成功回调
**server\center_scripts\WantedPlayer.lua**逻辑封装给悬赏通缉发放邮件使用
OnWantedSuccess (strWantedMan, strPayMan, nMoneyG, nTotalMoneyG)
改动：程序同步排行榜，注释加排行榜内容
改动：添加远程调用，加 10 s 不生效的提示 buff

## 6. 被悬赏者相关
- **远程调用，加 10 s 不生效的提示 buff-延迟悬赏**
**scripts/RemoteFromCenter/On_Wanted.lua**
RemoteCallToClient调用接口，悬赏后获得10s不生效buff31297,1
Scripts/RemoteFromCenter/RegisterFunction. Lua
**scripts/Map/世界通用/skill/悬赏延迟生效时间到.lua**
On_Wanted_Success (dwPlayerID)
改动：buff 添加和结束的时候发提示

**攻防期间获得的buff最后需要替换怨念buff**
scripts\Map\竞技场\skill\更换BUFF为怨念BUFF.lua

**悬念buff可以吃道具消耗的脚本**
scripts/Map/世界通用/item/顺气丸-消除悬赏怨念效果.lua

**Player 导出值修改**
- scripts/skill/江湖/骑乘_天灯.lua
- scripts/Map/江湖百态/驭兽师/include/驭兽师_Data.lua
- scripts/player/PlayerDeath.lua
  改动：bWanted改为nWantedTypeMask
  WANTED_TYPE_CODE. PUBLIC
  WANTED_TYPE_CODE. PRIVATE

## 7. 击杀者相关
 **击杀者信息显示条件**
**scripts/player/include/野外击杀复仇头文件.lua**
KillBanEscape(scene, killer, player)
	野外复仇开关999=true，除了GF地图GF时间、帮会领地战的帮会地图、场景阵营对抗激烈开启性能优化、战场、竞技场，**存储击杀者信息**`SetKillerData(killer, player)`
	Buff：31304、31305、31306


**申请查看最近击杀人信息**
**scripts/RemoteFromClient/On_Camp.lua**
**Scripts/RemoteFromClient/RegisterFunction. Lua**
On_Camp_UpdateKiller(player) *--player是被杀者*  更新击杀者信息

**玩家头顶效果**
**ui/Script/player.lua**
UpdatePlayerTitleEffect(dwPlayerID)更新玩家头顶效果
Represent/common/global_effect. Txt 配私密悬赏特效
被公开悬赏dwEffectID = 47
被私有悬赏dwEffectID = 223

**中地图显示**
**ui\Config\Default\MiddleMap.lua**

**击杀者限制，根据是否有buff31003判断（暂时不上）**
- 过图/trunk/client/scripts/other/SwitchMap.lua
- 师徒召请scripts/Mentor/Evoke_common.lua
- 好友援助（义金兰）scripts/Map/好友系统/include/HelpData.lua
- 进副本scripts/Map/世界通用/include/界面传送通用判断.lua
- 进本服&跨服竞技场JJCscripts/player/ArenaFunction.lua
- 进本服&跨服&排队战场scripts/player/BattlefieldFunction.lua
- 坐马车scripts/Traffic/AutoFly.lua
- 跨服神行scripts/RemoteFromClient/On_CrossServer.lua
- 本服神行scripts/skill/经脉/基础系/基础系_子技能_传送增强.lua
- 无法使用大轻功、双人轻功scripts/skill/轻功/协同轻功/协同冲刺通用脚本.lua



